<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI éš”ç©ºæ‰‹åŠ¿ç»˜å›¾ (ç§»åŠ¨ç«¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
        }

        /* è§†é¢‘éšè—ï¼Œåªç”¨äºé‡‡é›† */
        #input_video {
            display: none;
        }

        /* ç”»å¸ƒå…¨å± */
        #output_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* çŠ¶æ€æ¡ */
        #status-bar {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            font-size: 14px;
            pointer-events: none;
            z-index: 10;
        }

        /* å¯åŠ¨é®ç½© (iOSå¿…é¡»æ‰‹åŠ¨è§¦å‘) */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        #start-btn {
            padding: 15px 40px;
            font-size: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 30px;
            margin-top: 20px;
            cursor: pointer;
        }

        /* UI é¢æ¿ (å“åº”å¼é€‚é…æ‰‹æœº) */
        #ui-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            z-index: 20;
        }

        .panel-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .panel-title {
            text-align: center;
            font-weight: bold;
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .btn.active {
            border-color: #007bff;
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }

        .color-btn {
            width: 35px;
            height: 35px;
        }

        /* è™šæ‹Ÿå…‰æ ‡ */
        #cursor {
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(255, 0, 0, 0.6);
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 30;
            display: none;
            transform: translate(-50%, -50%);
            /* å±…ä¸­å¯¹é½åæ ‡ */
        }
    </style>
</head>

<body>

    <div id="start-screen">
        <h2>AI æ‰‹åŠ¿ç»˜å›¾ (ç§»åŠ¨ç‰ˆ)</h2>
        <p>è¯·å…è®¸ä½¿ç”¨æ‘„åƒå¤´æƒé™</p>
        <p>ğŸ–ï¸ å¼ å¼€æ‰‹æŒ: èœå• / é€€å‡º</p>
        <p>ğŸ‘Œ æåˆé£ŸæŒ‡: ä¹¦å†™</p>
        <p>âœŒï¸ å‰ªåˆ€æ‰‹: æ¸…å±</p>
        <button id="start-btn">ç‚¹å‡»å¼€å§‹ä½“éªŒ</button>
    </div>

    <div id="status-bar">ç­‰å¾…å¯åŠ¨...</div>

    <video id="input_video" playsinline webkit-playsinline></video>
    <canvas id="output_canvas"></canvas>
    <div id="cursor"></div>

    <div id="ui-panel">
        <div class="panel-title">æ§åˆ¶é¢æ¿</div>
        <div class="panel-row">
            <div class="btn tool-btn active" data-tool="pen" style="background:#eee">âœï¸</div>
            <div class="btn tool-btn" data-tool="eraser" style="background:#eee">ğŸ§½</div>
        </div>
        <div class="panel-row">
            <div class="btn color-btn active" data-color="#000000" style="background: black;"></div>
            <div class="btn color-btn" data-color="#ff0000" style="background: red;"></div>
            <div class="btn color-btn" data-color="#00ff00" style="background: lime;"></div>
            <div class="btn color-btn" data-color="#00ccff" style="background: #00ccff;"></div>
        </div>
        <div class="panel-row">
            <div class="btn size-btn" data-size="3" style="background:#eee; font-size: 10px;">â€¢</div>
            <div class="btn size-btn active" data-size="8" style="background:#eee;">â—</div>
            <div class="btn size-btn" data-size="18" style="background:#eee; font-size: 20px;">â¬¤</div>
        </div>
    </div>

    <script>
        // --- å˜é‡å®šä¹‰ ---
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const uiPanel = document.getElementById('ui-panel');
        const cursor = document.getElementById('cursor');
        const statusText = document.getElementById('status-bar');
        const startScreen = document.getElementById('start-screen');

        let isPanelOpen = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let currentSize = 8;
        let globalScale = 1.0;
        let strokes = [];
        let currentStroke = null;
        let particles = [];
        let isClearing = false;
        let prevPinchDist = null;

        // è§†é¢‘æµå°ºå¯¸ä¿®æ­£å‚æ•°
        let videoScale = 1;
        let videoOffsetX = 0;
        let videoOffsetY = 0;

        // --- è¾…åŠ©å‡½æ•° ---
        function calcDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        // --- åæ ‡è½¬æ¢æ ¸å¿ƒ (å…³é”®: è§£å†³æ‰‹æœºå±å¹•æ¯”ä¾‹é—®é¢˜) ---
        function transformCoordinates(normX, normY) {
            // MediaPipe è¾“å‡ºæ˜¯ 0-1 çš„å½’ä¸€åŒ–åæ ‡ã€‚
            // ä½†æˆ‘ä»¬çš„ç”»å¸ƒæ˜¯ "object-fit: cover" å¡«å……çš„ï¼Œè§†é¢‘è¢«è£å‰ªäº†ã€‚
            // éœ€è¦å°†å½’ä¸€åŒ–åæ ‡æ˜ å°„å›çœŸå®çš„å±å¹•åƒç´ åæ ‡ã€‚

            // 1. é•œåƒåè½¬ X (å› ä¸ºæ˜¯å‰ç½®æ‘„åƒå¤´)
            let x = 1.0 - normX;
            let y = normY;

            // 2. æ˜ å°„åˆ°åŒ…å«åç§»é‡çš„å®é™…æ¸²æŸ“å°ºå¯¸
            // è§†é¢‘åœ¨ç”»å¸ƒä¸Šå®é™…æ¸²æŸ“çš„å¤§å°æ˜¯ videoWidth * videoScale
            let renderX = x * (videoElement.videoWidth * videoScale);
            let renderY = y * (videoElement.videoHeight * videoScale);

            // 3. å‡å»åç§»é‡ (å±…ä¸­å‰ªè£æ‰çš„éƒ¨åˆ†)
            let finalX = renderX + videoOffsetX;
            let finalY = renderY + videoOffsetY;

            return { x: finalX, y: finalY };
        }

        // --- ç²’å­ç³»ç»Ÿ ---
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = Math.random() * 3 + 2;
                this.life = 1.0;
            }
            update() {
                this.x += this.vx; this.y += this.vy; this.life -= 0.03;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 4, 4); ctx.globalAlpha = 1.0;
            }
        }

        function triggerSnowEffect() {
            if (isClearing || strokes.length === 0) return;
            isClearing = true;
            statusText.innerText = "â„ï¸ æ¸…å±ä¸­...";

            // é™ä½ç§»åŠ¨ç«¯ç²’å­å¯†åº¦
            const density = 3;
            strokes.forEach(stroke => {
                for (let i = 0; i < stroke.points.length; i += density) {
                    const p = stroke.points[i];
                    // åº”ç”¨å½“å‰ç¼©æ”¾
                    const x = (p.x - canvasElement.width / 2) * globalScale + canvasElement.width / 2;
                    const y = (p.y - canvasElement.height / 2) * globalScale + canvasElement.height / 2;
                    particles.push(new Particle(x, y, stroke.color));
                }
            });
            strokes = [];
        }

        // --- ç»˜å›¾å¾ªç¯ ---
        function drawCanvas() {
            // è®¡ç®—å±å¹•é€‚é…
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;

            const vW = videoElement.videoWidth;
            const vH = videoElement.videoHeight;
            const cW = canvasElement.width;
            const cH = canvasElement.height;

            if (vW && vH) {
                // è®¡ç®— "object-fit: cover" çš„æ¯”ä¾‹
                const scale = Math.max(cW / vW, cH / vH);
                videoScale = scale;
                const renderW = vW * scale;
                const renderH = vH * scale;
                // è®¡ç®—åç§»é‡ä»¥å±…ä¸­
                videoOffsetX = (cW - renderW) / 2;
                videoOffsetY = (cH - renderH) / 2;

                // ç»˜åˆ¶è§†é¢‘èƒŒæ™¯ (é•œåƒ)
                canvasCtx.save();
                // ç§»åŠ¨åˆ°ä¸­å¿ƒ
                canvasCtx.translate(cW / 2, cH / 2);
                canvasCtx.scale(-1, 1); // é•œåƒ
                canvasCtx.translate(-cW / 2, -cH / 2);
                // ç»˜åˆ¶å›¾ç‰‡ (æ³¨æ„ï¼šç”±äºå·²ç»é•œåƒï¼ŒdrawImage å‚æ•°éœ€è¦é€»è¾‘åè½¬æˆ–è€…ç®€å•å¤„ç†)
                // æ›´ç®€å•çš„æ–¹æ³•ï¼šç›´æ¥ç”»ï¼Œç„¶åé€šè¿‡åæ ‡è½¬æ¢å¤„ç†é•œåƒï¼Œä½†ä¸ºäº†è§†è§‰ä¸€è‡´ï¼Œæˆ‘ä»¬è¿™é‡Œç”»é•œåƒè§†é¢‘

                // ç¨å¾®å¤æ‚çš„å˜æ¢æ¥ä¿è¯ cover æ•ˆæœæ­£ç¡®
                // é‡ç½®å˜æ¢ä¸ºäº†ç®€å•çš„ drawImage
                canvasCtx.restore();
                canvasCtx.save();
                canvasCtx.translate(cW / 2, cH / 2);
                canvasCtx.scale(-1, 1); // é•œåƒæ•´ä¸ªç”»å¸ƒä¸Šä¸‹æ–‡
                // æ­¤æ—¶ä¸­å¿ƒç‚¹æ˜¯ 0,0ã€‚
                canvasCtx.drawImage(videoElement, -renderW / 2, -renderH / 2, renderW, renderH);
                canvasCtx.restore();
            } else {
                canvasCtx.fillStyle = '#333';
                canvasCtx.fillRect(0, 0, cW, cH);
            }

            // ç»˜åˆ¶ç¬”è¿¹
            canvasCtx.save();
            canvasCtx.translate(cW / 2, cH / 2);
            canvasCtx.scale(globalScale, globalScale);
            canvasCtx.translate(-cW / 2, -cH / 2);
            canvasCtx.lineCap = 'round';
            canvasCtx.lineJoin = 'round';

            strokes.forEach(stroke => {
                canvasCtx.beginPath();
                canvasCtx.lineWidth = stroke.size;
                canvasCtx.strokeStyle = stroke.tool === 'eraser' ? 'rgba(255,255,255,0.8)' : stroke.color;
                // æ©¡çš®æ“¦åœ¨ç§»åŠ¨ç«¯ç”¨åŠé€æ˜ç™½è‰²æ¨¡æ‹Ÿ

                if (stroke.points.length > 0) {
                    canvasCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
                    for (let i = 1; i < stroke.points.length; i++) {
                        canvasCtx.lineTo(stroke.points[i].x, stroke.points[i].y);
                    }
                }
                canvasCtx.stroke();
            });
            canvasCtx.restore();

            // ç²’å­
            if (particles.length > 0) {
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    particles[i].draw(canvasCtx);
                    if (particles[i].life <= 0) particles.splice(i, 1);
                }
                if (particles.length === 0 && isClearing) {
                    isClearing = false;
                    statusText.innerText = "ğŸ–ï¸ è¯·å±•ç¤ºæ‰‹æŒ";
                }
            }
        }

        // --- MediaPipe å¤„ç† ---
        function onResults(results) {
            drawCanvas();

            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                cursor.style.display = 'none';
                return;
            }

            const handsData = results.multiHandLandmarks;

            // --- åŒæ‰‹ç¼©æ”¾ ---
            if (handsData.length === 2) {
                const p1 = transformCoordinates(handsData[0][8].x, handsData[0][8].y);
                const p2 = transformCoordinates(handsData[1][8].x, handsData[1][8].y);
                const dist = calcDistance(p1, p2);

                statusText.innerText = "ğŸ‘ åŒæŒ‡ç¼©æ”¾ä¸­";
                if (prevPinchDist) {
                    const delta = dist - prevPinchDist;
                    if (Math.abs(delta) > 2) globalScale = Math.max(0.5, Math.min(3.0, globalScale * (1 + delta * 0.003)));
                }
                prevPinchDist = dist;
                return;
            } else {
                prevPinchDist = null;
            }

            // --- å•æ‰‹é€»è¾‘ ---
            const landmarks = handsData[0];
            const indexTip = transformCoordinates(landmarks[8].x, landmarks[8].y);
            const thumbTip = transformCoordinates(landmarks[4].x, landmarks[4].y);

            // ç®€å•çš„æ‰‹åŠ¿åˆ¤æ–­
            const isPinkyOpen = landmarks[20].y < landmarks[18].y; // æ³¨æ„ï¼šyå‘ä¸‹å¢å¤§ï¼Œupæ˜¯æ›´å°
            const isIndexOpen = landmarks[8].y < landmarks[6].y;
            const isMiddleOpen = landmarks[12].y < landmarks[10].y;

            // ä¼˜åŒ–ç§»åŠ¨ç«¯æ‰‹æŒæ£€æµ‹ï¼šåªè¦4ä¸ªæŒ‡å¤´éƒ½æ¯”è¾ƒç›´
            const isPalm = isIndexOpen && isMiddleOpen && isPinkyOpen && (calcDistance(indexTip, thumbTip) > 80);

            // æåˆæ£€æµ‹
            const pinchDist = calcDistance(indexTip, thumbTip);
            const isPinch = pinchDist < 50; // ç§»åŠ¨ç«¯åˆ¤å®šè·ç¦»

            // å‰ªåˆ€æ‰‹
            const isVictory = isIndexOpen && isMiddleOpen && !isPinkyOpen && (calcDistance(indexTip, thumbTip) > 60);

            // çŠ¶æ€æœº
            if (isVictory) {
                triggerSnowEffect();
                return;
            }

            if (isPanelOpen) {
                cursor.style.display = 'block';
                cursor.style.left = indexTip.x + 'px';
                cursor.style.top = indexTip.y + 'px';
                statusText.innerText = "ğŸ‘† ç§»åŠ¨é£ŸæŒ‡é€‰æ‹©";

                if (isPalm && !isPinch) {
                    // å…³é—­é¢æ¿éœ€è¦ä¸€ç‚¹é˜²æŠ–ï¼Œæˆ–è€…ç”¨ç‰¹å®šåŒºåŸŸï¼Œè¿™é‡Œç®€åŒ–ä¸ºå¼ å¼€æ‰‹æŒå…³é—­
                    // ä¸ºäº†ä½“éªŒæ›´å¥½ï¼Œæˆ‘ä»¬åœ¨ç§»åŠ¨ç«¯æ£€æµ‹æ˜¯å¦"ç‚¹å‡»"äº†å¤–é¢ï¼Œæˆ–è€…å†æ¬¡å¼ æ‰‹
                    // ç®€å•åŒ–ï¼šå¼ æ‰‹å…³é—­
                    uiPanel.style.display = 'none';
                    isPanelOpen = false;
                    return;
                }

                // æ¨¡æ‹Ÿç‚¹å‡»: é£ŸæŒ‡æ‚¬åœ
                checkUICollision(indexTip.x, indexTip.y);

            } else {
                // ç»˜å›¾æ¨¡å¼
                if (isPalm) {
                    if (!currentStroke) {
                        uiPanel.style.display = 'flex';
                        isPanelOpen = true;
                        statusText.innerText = "èœå•å·²æ‰“å¼€";
                        return;
                    }
                }

                cursor.style.display = 'block';
                cursor.style.left = indexTip.x + 'px';
                cursor.style.top = indexTip.y + 'px';
                cursor.style.background = isPinch ? '#00ff00' : 'rgba(255,0,0,0.5)';

                if (isPinch) {
                    statusText.innerText = "âœï¸ ä¹¦å†™ä¸­...";
                    // é€†å‘ç¼©æ”¾åæ ‡
                    const rawX = (indexTip.x - canvasElement.width / 2) / globalScale + canvasElement.width / 2;
                    const rawY = (indexTip.y - canvasElement.height / 2) / globalScale + canvasElement.height / 2;

                    if (!currentStroke) {
                        currentStroke = {
                            tool: currentTool, color: currentColor, size: currentSize / globalScale,
                            points: [{ x: rawX, y: rawY }]
                        };
                        strokes.push(currentStroke);
                    } else {
                        currentStroke.points.push({ x: rawX, y: rawY });
                    }
                } else {
                    statusText.innerText = "ğŸ‘Œ æåˆé£ŸæŒ‡ä¹¦å†™";
                    currentStroke = null;
                }
            }
        }

        // --- UI ç¢°æ’ ---
        function checkUICollision(x, y) {
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                const rect = btn.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    handleBtnClick(btn);
                }
            });
        }

        function handleBtnClick(btn) {
            if (btn.classList.contains('active')) return;
            // ç®€å•éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) navigator.vibrate(20);

            if (btn.classList.contains('tool-btn')) {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.getAttribute('data-tool');
            } else if (btn.classList.contains('color-btn')) {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentColor = btn.getAttribute('data-color');
                currentTool = 'pen';
            } else if (btn.classList.contains('size-btn')) {
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSize = parseInt(btn.getAttribute('data-size'));
            }
        }

        // --- åˆå§‹åŒ–å¯åŠ¨ ---
   const hands = new Hands({ 
    locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }
});
        hands.setOptions({
    maxNumHands: 1,      // æ”¹ä¸º 1ï¼Œå•æ‰‹æ“ä½œæ›´æµç•…
    modelComplexity: 0,  
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5,
    selfieMode: true     // å¢åŠ è¿™ä¸€è¡Œï¼Œä¼˜åŒ–å‰ç½®æ‘„åƒå¤´è¯†åˆ«
});
        hands.onResults(onResults);

        document.getElementById('start-btn').addEventListener('click', () => {
            statusText.innerText = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
            startScreen.style.display = 'none';

            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({ image: videoElement }); },
                width: 1280,
                height: 720,
                facingMode: 'user' // å¼ºåˆ¶å‰ç½®æ‘„åƒå¤´
            });
            camera.start().then(() => {
                statusText.innerText = "ç³»ç»Ÿå°±ç»ª - è¯·å±•ç¤ºæ‰‹æŒ";
            }).catch(e => {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + e.message + "\nè¯·ç¡®ä¿åœ¨ HTTPS ç¯å¢ƒä¸‹è¿è¡Œã€‚");
            });
        });

    </script>
</body>


</html>

